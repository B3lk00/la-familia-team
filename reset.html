<!DOCTYPE html>
<html lang="bs">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Reset lozinke | La Familia</title>
<style>
:root{--bg:#0f1117;--card:#1c1f2a;--line:#2a2f3d;--muted:#a7adbb;--acc:#ff2e63;}
*{box-sizing:border-box}
body{margin:0;font-family:'Segoe UI',sans-serif;background:var(--bg);color:#fff;display:flex;min-height:100vh;align-items:center;justify-content:center;padding:18px}
.card{width:min(520px, 94vw);background:rgba(28,31,42,.85);border:1px solid var(--line);border-radius:18px;padding:16px}
h1{margin:0 0 10px}
.small{color:var(--muted);font-size:13px}
input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#0b0d12;color:#fff;margin-top:10px}
.btn{margin-top:12px;width:100%;padding:12px 14px;border-radius:12px;border:0;background:var(--acc);color:#fff;font-weight:900;cursor:pointer}
</style>
</head>
<body>

<div class="card">
  <h1>Promjena lozinke</h1>
  <div class="small">Upiši novu lozinku. Nakon toga možeš se prijaviti.</div>

  <input id="pw" type="password" placeholder="Nova lozinka" />
  <input id="pw2" type="password" placeholder="Potvrdi novu lozinku" />

  <button class="btn" onclick="setNewPassword()">Sačuvaj</button>
  <div id="msg" class="small" style="margin-top:10px"></div>

  <div class="small" style="margin-top:12px">
    <a href="login.html" style="color:#fff; text-decoration:underline; opacity:.85">Nazad na login</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>

<script>
const msg = document.getElementById("msg");

// ✅ OVO JE KLJUČNO
async function initRecovery(){
  const { data, error } =
    await window.sb.auth.getSessionFromUrl({
      storeSession: true
    });

  if(error){
    msg.textContent =
      "Reset link nije validan ili je istekao.";
    return;
  }
}

initRecovery();

async function setNewPassword(){
  const pw = document.getElementById("pw").value;
  const pw2 = document.getElementById("pw2").value;

  if(!pw || pw.length < 6){
    msg.textContent="Lozinka mora imati min 6 karaktera.";
    return;
  }

  if(pw !== pw2){
    msg.textContent="Lozinke se ne poklapaju.";
    return;
  }

  msg.textContent="Spremam novu lozinku...";

  const { error } =
    await window.sb.auth.updateUser({
      password: pw
    });

  if(error){
    msg.textContent="Greška: "+error.message;
    return;
  }

  msg.textContent="✅ Lozinka promijenjena!";

  setTimeout(()=>{
    window.location.href="login.html";
  },1500);
}
</script>

</body>
</html>
